--
--BLOCCO DROP DELLE TABELLE ESISTENTI
--

DROP TABLE AM_AI_ROLE CASCADE;
DROP TABLE AM_ANAGRAFICA CASCADE;
DROP TABLE AM_APPLICATION CASCADE;
DROP TABLE AM_APPLICATION_ITEM CASCADE;
DROP TABLE AM_COMUNE CASCADE;
DROP TABLE AM_FONTE CASCADE;
DROP TABLE AM_FONTE_COMUNE CASCADE;
DROP TABLE AM_FONTE_TIPOINFO CASCADE;
DROP TABLE AM_GROUP CASCADE;
DROP TABLE AM_GROUP_AIR CASCADE;
DROP TABLE AM_INSTANCE CASCADE;
DROP TABLE AM_INSTANCE_COMUNE CASCADE;
DROP TABLE AM_ITEM CASCADE;
DROP TABLE AM_KEY_VALUE CASCADE;
DROP TABLE AM_KEY_VALUE_EXT CASCADE;
DROP TABLE AM_PERMISSION CASCADE;
DROP TABLE AM_PERMISSION_AIR CASCADE;
DROP TABLE AM_ROLE CASCADE;
DROP TABLE AM_SECTION CASCADE;
DROP TABLE AM_USER CASCADE;
DROP TABLE AM_USER_AIR CASCADE;
DROP TABLE AM_USER_GROUP CASCADE;

--
--BLOCCO CREAZIONE TABELLE
--

CREATE TABLE AM_AI_ROLE
(
	ID                      INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	FK_AM_APPLICATION_ITEM  INTEGER,
	FK_AM_ROLE              VARCHAR(64)
);

CREATE TABLE AM_ANAGRAFICA
(
	ID						INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	CAP						VARCHAR(8),
	CITTADINANZA			VARCHAR(64),
	CODICE_FISCALE			VARCHAR(16),
	COGNOME					VARCHAR(64),
	COMUNE_NASCITA			VARCHAR(64),
	COMUNE_RESIDENZA		VARCHAR(64),
	DATA_NASCITA			DATE,
	INDIRIZZO				VARCHAR(64),
	NOME					VARCHAR(64),
	NUMERO					VARCHAR(8),
	PROVINCIA_NASCITA		VARCHAR(64),
	PROVINCIA_RESIDENZA		VARCHAR(64),
	SESSO					VARCHAR(8),
	FK_AM_USER				VARCHAR(64),
	FK_CeT_ANAGRAGICA		INTEGER
);

CREATE TABLE AM_APPLICATION
(
	NAME					VARCHAR(64) NOT NULL,
	URL						VARCHAR(1024),
	APP_TYPE				VARCHAR(1024),
	APP_CATEGORY			VARCHAR(1024)
);

CREATE TABLE AM_APPLICATION_ITEM
(
	ID						INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	FK_AM_APPLICATION		VARCHAR(64),
	FK_AM_ITEM				VARCHAR(64)
);

CREATE TABLE AM_COMUNE
(
	BELFIORE				VARCHAR(64),
	DESCRIZIONE				VARCHAR(1024)
);

CREATE TABLE AM_FONTE
(
	ID						INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	CODICE					VARCHAR(20),
	DESCRIZIONE				VARCHAR(255),
	TIPO_FONTE				VARCHAR(1),
	N_ORDINE				INTEGER
);

CREATE TABLE AM_FONTE_COMUNE
(
	FK_AM_COMUNE			VARCHAR(64),
	FK_AM_FONTE				INTEGER
);

CREATE TABLE AM_FONTE_TIPOINFO
(
	FK_AM_FONTE				INTEGER,
	INFORMAZIONE			VARCHAR(2000),
	PROG_OLD				INTEGER,
	N_ORDINE_SU_FONTE		INTEGER
);

CREATE TABLE AM_GROUP
(
	NAME					VARCHAR(64) NOT NULL,
	FK_AM_COMUNE			VARCHAR(64)
);

CREATE TABLE AM_GROUP_AIR
(
	FK_AM_AI_ROLE			INTEGER,
	FK_AM_GROUP				VARCHAR(64)
);

CREATE TABLE AM_INSTANCE
(
	NAME					VARCHAR(64) NOT NULL,
	FK_AM_APPLICATION		VARCHAR(64),
	URL						VARCHAR(1024)
);

CREATE TABLE AM_INSTANCE_COMUNE
(
	FK_AM_COMUNE			VARCHAR(64),
	FK_AM_INSTANCE			VARCHAR(64)
);

CREATE TABLE AM_ITEM
(
	NAME					VARCHAR(64) NOT NULL
);

CREATE TABLE AM_KEY_VALUE
(    
	ID						INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	KEY_CONF				VARCHAR(64),
	VALUE_CONF				VARCHAR(2048),
	DELETED					DATE,
	MUST_BE_SET				VARCHAR(1),
	OVERW_TYPE				VARCHAR(1),
	SECTION_NAME			VARCHAR(1024),
	FK_AM_APPLICATION		VARCHAR(64),
	DESCRIZIONE_KEY			VARCHAR(1024)
);

CREATE TABLE AM_KEY_VALUE_EXT
(
	ID						INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	KEY_CONF				VARCHAR(64),
	VALUE_CONF				VARCHAR(2048),
	EXT_TYPE				VARCHAR(1),
	FK_AM_COMUNE			VARCHAR(64),
	FK_AM_INSTANCE			VARCHAR(64),
	FK_AM_FONTE				INTEGER,
	SECTION_NAME			VARCHAR(1024),
	FK_AM_APPLICATION		VARCHAR(64)
);

CREATE TABLE AM_PERMISSION
(
	NAME 					VARCHAR(64) NOT NULL,
	FK_AM_ITEM				VARCHAR(64)
);

CREATE TABLE AM_PERMISSION_AIR
(
	FK_AM_PERMISSION		VARCHAR(64),
	FK_AM_AI_ROLE			INTEGER
);

CREATE TABLE AM_ROLE
(
	NAME					VARCHAR(64) NOT NULL
);

CREATE TABLE AM_SECTION
(    
	ID						INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
	NAME					VARCHAR(64) NOT NULL,
	TIPO					INTEGER,
	FK_AM_APPLICATION		VARCHAR(64),
	FK_AM_FONTE				INTEGER,
	ORDINE					INTEGER
);

CREATE TABLE AM_USER
(
	NAME					VARCHAR(64) NOT NULL,
	PWD						VARCHAR(1024),
	DT_INS					DATE,
	USER_INS				VARCHAR(1024),
	LAST_ACCESS				DATE,
	DISABLE_CAUSE			VARCHAR(1024),
	DT_UPD_PWD				DATE
);

CREATE TABLE AM_USER_AIR
(
	FK_AM_AI_ROLE			INTEGER,
	FK_AM_USER				VARCHAR(64)
);

CREATE TABLE AM_USER_GROUP
(
	FK_AM_GROUP				VARCHAR(64),
	FK_AM_USER				VARCHAR(64)
);

-- 
-- BLOCCO CREAZIONE CHIAVI PRIMARIE ED INDICI UNIVOCI
-- 


--ALTER TABLE AM_AI_ROLE ADD CONSTRAINT PK_AM_AI_ROLE PRIMARY KEY(ID);
CREATE UNIQUE INDEX PK_AM_AI_ROLE ON AM_AI_ROLE(ID);
CREATE UNIQUE INDEX FK_AM_AI_ROLE ON AM_AI_ROLE(FK_AM_ROLE, FK_AM_APPLICATION_ITEM);


--ALTER TABLE AM_ANAGRAFICA ADD CONSTRAINT PK_AM_ANAGRAFICA PRIMARY KEY (ID);
CREATE UNIQUE INDEX PK_AM_ANAGRAFICA ON AM_ANAGRAFICA(ID);
 
ALTER TABLE AM_APPLICATION ADD CONSTRAINT PK_AM_APPLICATION PRIMARY KEY(NAME);
CREATE UNIQUE INDEX PK_AM_APPLICATION ON AM_APPLICATION(NAME);
CREATE UNIQUE INDEX FK_AM_APPLICATION_ITEM ON AM_APPLICATION_ITEM(FK_AM_APPLICATION, FK_AM_ITEM);

--ALTER TABLE AM_APPLICATION_ITEM ADD CONSTRAINT PK_AM_APPLICATION_ITEM PRIMARY KEY(ID);
CREATE UNIQUE INDEX PK_AM_APPLICATION_ITEM ON AM_APPLICATION_ITEM(ID);


ALTER TABLE AM_COMUNE ADD CONSTRAINT PK_AM_COMUNE PRIMARY KEY (BELFIORE);
CREATE UNIQUE INDEX PK_AM_COMUNE ON AM_COMUNE (BELFIORE);


--ALTER TABLE AM_FONTE ADD CONSTRAINT PK_AM_FONTE PRIMARY KEY (ID);
CREATE UNIQUE INDEX PK_AM_FONTE ON AM_FONTE (ID);

ALTER TABLE AM_FONTE_COMUNE ADD CONSTRAINT PK_AM_FONTE_COMUNE PRIMARY KEY (FK_AM_FONTE, FK_AM_COMUNE);
CREATE UNIQUE INDEX PK_AM_FONTE_COMUNE ON AM_FONTE_COMUNE(FK_AM_FONTE, FK_AM_COMUNE);

ALTER TABLE AM_FONTE_TIPOINFO ADD CONSTRAINT PK_AM_FONTE_TIPOINFO PRIMARY KEY (FK_AM_FONTE, INFORMAZIONE);
CREATE UNIQUE INDEX PK_AM_FONTE_TIPOINFO ON AM_FONTE_TIPOINFO(FK_AM_FONTE, INFORMAZIONE);

ALTER TABLE AM_GROUP ADD CONSTRAINT PK_AM_GROUP PRIMARY KEY (NAME);
CREATE UNIQUE INDEX PK_AM_GROUP ON AM_GROUP(NAME);

CREATE UNIQUE INDEX FK_AM_GROUP_AIR ON AM_GROUP_AIR(FK_AM_GROUP, FK_AM_AI_ROLE);

ALTER TABLE AM_INSTANCE ADD CONSTRAINT PK_AM_INSTANCE PRIMARY KEY(NAME);
CREATE UNIQUE INDEX PK_AM_INSTANCE ON AM_INSTANCE (NAME);

ALTER TABLE AM_INSTANCE_COMUNE ADD CONSTRAINT PK_AM_INSTANCE_COMUNE PRIMARY KEY (FK_AM_COMUNE, FK_AM_INSTANCE);
CREATE UNIQUE INDEX PK_AM_INSTANCE_COMUNE ON AM_INSTANCE_COMUNE(FK_AM_COMUNE, FK_AM_INSTANCE);

ALTER TABLE AM_ITEM ADD CONSTRAINT PK_AM_ITEM PRIMARY KEY (NAME);
CREATE UNIQUE INDEX PK_AM_ITEM ON AM_ITEM(NAME);

CREATE UNIQUE INDEX UK_AM_KEY_VALUE ON AM_KEY_VALUE(KEY_CONF, SECTION_NAME, FK_AM_APPLICATION);
ALTER TABLE AM_KEY_VALUE ADD CONSTRAINT UK_AM_KEY_VALUE UNIQUE (KEY_CONF, SECTION_NAME, FK_AM_APPLICATION);

CREATE UNIQUE INDEX PK_AM_KEY_VALUE_EXT ON AM_KEY_VALUE_EXT(KEY_CONF, SECTION_NAME, FK_AM_APPLICATION, FK_AM_FONTE);

ALTER TABLE AM_PERMISSION ADD CONSTRAINT PK_AM_PERMISSION PRIMARY KEY (NAME);
CREATE UNIQUE INDEX PK_AM_PERMISSION ON AM_PERMISSION(NAME);

CREATE UNIQUE INDEX FK_AM_PERMISSION_AIR ON AM_PERMISSION_AIR(FK_AM_PERMISSION, FK_AM_AI_ROLE);

ALTER TABLE AM_ROLE ADD CONSTRAINT PK_AM_ROLE PRIMARY KEY (NAME);
CREATE UNIQUE INDEX PK_AM_ROLE ON AM_ROLE(NAME);

ALTER TABLE AM_SECTION ADD CONSTRAINT UK_AM_SECTION UNIQUE (NAME, FK_AM_APPLICATION);

ALTER TABLE AM_USER ADD CONSTRAINT PK_AM_USER PRIMARY KEY (NAME);
CREATE UNIQUE INDEX PK_AM_USER ON AM_USER(NAME);

CREATE UNIQUE INDEX FK_AM_USER_AIR ON AM_USER_AIR(FK_AM_USER, FK_AM_AI_ROLE);

CREATE UNIQUE INDEX FK_AM_USER_GROUP ON AM_USER_GROUP(FK_AM_USER, FK_AM_GROUP);



-- 
-- BLOCCO CREAZIONE CHIAVI ESTERNE(FOREIGN KEY)
-- 

ALTER TABLE AM_INSTANCE_COMUNE ADD CONSTRAINT FK_AM_IC_AM_COMUNE 
 FOREIGN KEY (FK_AM_COMUNE) 
 REFERENCES AM_COMUNE (BELFIORE);

ALTER TABLE AM_INSTANCE_COMUNE ADD 
  CONSTRAINT FK_AM_IC_AM_INSTANCE 
 FOREIGN KEY (FK_AM_INSTANCE) 
 REFERENCES AM_INSTANCE (NAME);


ALTER TABLE AM_GROUP ADD 
  CONSTRAINT FK_AM_GROUP_AM_COMUNE 
 FOREIGN KEY (FK_AM_COMUNE) 
 REFERENCES AM_COMUNE (BELFIORE);


ALTER TABLE AM_USER_GROUP ADD 
  CONSTRAINT FK_AM_USER_GROUP_AM_GROUP 
 FOREIGN KEY (FK_AM_GROUP) 
 REFERENCES AM_GROUP (NAME);

ALTER TABLE AM_USER_GROUP ADD 
  CONSTRAINT FK_AM_USER_GROUP_AM_USER 
 FOREIGN KEY (FK_AM_USER) 
 REFERENCES AM_USER (NAME);


ALTER TABLE AM_SECTION ADD 
  CONSTRAINT FK_AM_SECTION_FONTE 
 FOREIGN KEY (FK_AM_FONTE) 
 REFERENCES AM_FONTE (ID);

ALTER TABLE AM_SECTION ADD 
  CONSTRAINT FK_AM_SECTION_AM_APPLICATION 
 FOREIGN KEY (FK_AM_APPLICATION) 
 REFERENCES AM_APPLICATION (NAME);


ALTER TABLE AM_KEY_VALUE ADD 
  CONSTRAINT FK_KEY_VALUE_SECTION 
 FOREIGN KEY (SECTION_NAME, FK_AM_APPLICATION) 
 REFERENCES AM_SECTION (NAME,FK_AM_APPLICATION);


ALTER TABLE AM_ANAGRAFICA ADD 
  CONSTRAINT FK_AM_ANAGRAFICA_AM_USER 
 FOREIGN KEY (FK_AM_USER) 
 REFERENCES AM_USER (NAME);


ALTER TABLE AM_FONTE_COMUNE ADD 
  CONSTRAINT FK_AM_FONTE_COMUNE_FONTE 
 FOREIGN KEY (FK_AM_FONTE) 
 REFERENCES AM_FONTE (ID);

ALTER TABLE AM_FONTE_COMUNE ADD 
  CONSTRAINT FK_AM_FONTE_COMUNE_COMUNE 
 FOREIGN KEY (FK_AM_COMUNE) 
 REFERENCES AM_COMUNE (BELFIORE);


ALTER TABLE AM_KEY_VALUE_EXT ADD 
  CONSTRAINT FK_KEY_VALUE_EXT_SECTION 
 FOREIGN KEY (SECTION_NAME, FK_AM_APPLICATION) 
 REFERENCES AM_SECTION (NAME,FK_AM_APPLICATION);

ALTER TABLE AM_KEY_VALUE_EXT ADD 
  CONSTRAINT FK_KEY_EXT_FONTE_COMUNE 
 FOREIGN KEY (FK_AM_FONTE, FK_AM_COMUNE) 
 REFERENCES AM_FONTE_COMUNE (FK_AM_FONTE,FK_AM_COMUNE);

ALTER TABLE AM_KEY_VALUE_EXT ADD 
  CONSTRAINT FK_AM_KEY_VALUE_EXT_AM_COMUNE 
 FOREIGN KEY (FK_AM_COMUNE) 
 REFERENCES AM_COMUNE (BELFIORE);

ALTER TABLE AM_KEY_VALUE_EXT ADD 
  CONSTRAINT FK_AM_KEY_VALUE_EXT_INST_COM 
 FOREIGN KEY (FK_AM_COMUNE, FK_AM_INSTANCE) 
 REFERENCES AM_INSTANCE_COMUNE (FK_AM_COMUNE,FK_AM_INSTANCE);

ALTER TABLE AM_KEY_VALUE_EXT ADD 
  CONSTRAINT FK_AM_KEY_VALUE_EXT_AM_INST 
 FOREIGN KEY (FK_AM_INSTANCE) 
 REFERENCES AM_INSTANCE (NAME);


ALTER TABLE AM_FONTE_TIPOINFO ADD 
  CONSTRAINT FK_FONTE_TIPOINFO_FONTE 
 FOREIGN KEY (FK_AM_FONTE) 
 REFERENCES AM_FONTE (ID);


ALTER TABLE AM_PERMISSION ADD 
  CONSTRAINT FK_AM_PERMISSION_AM_ITEM 
 FOREIGN KEY (FK_AM_ITEM) 
 REFERENCES AM_ITEM (NAME);


ALTER TABLE AM_APPLICATION_ITEM ADD 
  CONSTRAINT FK_AM_AI_AM_APPLICATION 
 FOREIGN KEY (FK_AM_APPLICATION) 
 REFERENCES AM_APPLICATION (NAME);

ALTER TABLE AM_APPLICATION_ITEM ADD 
  CONSTRAINT FK_AM_AI_AM_ITEM 
 FOREIGN KEY (FK_AM_ITEM) 
 REFERENCES AM_ITEM (NAME);


ALTER TABLE AM_AI_ROLE ADD 
  CONSTRAINT FK_AM_AIR_AM_APPLICATION_ITEM 
 FOREIGN KEY (FK_AM_APPLICATION_ITEM) 
 REFERENCES AM_APPLICATION_ITEM (ID);

ALTER TABLE AM_AI_ROLE ADD 
  CONSTRAINT FK_AM_AIR_AM_ROLE 
 FOREIGN KEY (FK_AM_ROLE) 
 REFERENCES AM_ROLE (NAME);


ALTER TABLE AM_USER_AIR ADD 
  CONSTRAINT FK_AM_USER_AIR_AM_AI_ROLE 
 FOREIGN KEY (FK_AM_AI_ROLE) 
 REFERENCES AM_AI_ROLE (ID);

ALTER TABLE AM_USER_AIR ADD 
  CONSTRAINT FK_AM_USER_AIR_AM_USER 
 FOREIGN KEY (FK_AM_USER) 
 REFERENCES AM_USER (NAME);


ALTER TABLE AM_PERMISSION_AIR ADD 
  CONSTRAINT FK_AM_PAIR_AM_PERMISSION 
 FOREIGN KEY (FK_AM_PERMISSION) 
 REFERENCES AM_PERMISSION (NAME);

ALTER TABLE AM_PERMISSION_AIR ADD 
  CONSTRAINT FK_AM_PAIR_AM_GAI_ROLE 
 FOREIGN KEY (FK_AM_AI_ROLE) 
 REFERENCES AM_AI_ROLE (ID);


ALTER TABLE AM_GROUP_AIR ADD 
  CONSTRAINT FK_AM_GAIR_AM_AI_ROLE 
 FOREIGN KEY (FK_AM_AI_ROLE) 
 REFERENCES AM_AI_ROLE (ID);

ALTER TABLE AM_GROUP_AIR ADD 
  CONSTRAINT FK_AM_GAIR_AM_GROUP 
 FOREIGN KEY (FK_AM_GROUP) 
 REFERENCES AM_GROUP (NAME);
